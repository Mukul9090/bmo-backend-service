name: CI-CD Pipeline (Self-Hosted Runner + Minikube + HAProxy)

on:
  push:
    branches:
      - main

jobs:
  ci-cd:
    runs-on:
      - self-hosted
      - macOS
      - ARM64

    timeout-minutes: 20

    steps:
      # --------------------------------------------------
      # 1Ô∏è‚É£ Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # 2Ô∏è‚É£ Docker Hub Login
      # --------------------------------------------------
      - name: Docker Hub Login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
            -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # --------------------------------------------------
      # 3Ô∏è‚É£ Build & Push Image
      # --------------------------------------------------
      - name: Build Docker Image
        run: docker build -t mukul1599/backend-service:latest .

      - name: Push Docker Image
        run: docker push mukul1599/backend-service:latest

      # --------------------------------------------------
      # 4Ô∏è‚É£ Start / Reuse Minikube
      # --------------------------------------------------
      - name: Start Minikube
        run: |
          minikube status || minikube start --driver=docker
          kubectl config use-context minikube

      # --------------------------------------------------
      # 5Ô∏è‚É£ Clean stale K8s resources (CI-safe)
      # --------------------------------------------------
      - name: Cleanup old Kubernetes resources
        run: |
          kubectl delete deployment backend-service -n backend --ignore-not-found
          kubectl delete rs -n backend -l app=backend-service --ignore-not-found
          kubectl delete pod -n backend -l app=backend-service \
            --force --grace-period=0 || true

      # --------------------------------------------------
      # 6Ô∏è‚É£ Deploy manifests
      # --------------------------------------------------
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap-hot.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      # --------------------------------------------------
      # 7Ô∏è‚É£ Short wait (don‚Äôt block CI)
      # --------------------------------------------------
      - name: Wait briefly
        run: sleep 25

      # --------------------------------------------------
      # 8Ô∏è‚É£ Debug output (visible in CI UI)
      # --------------------------------------------------
      - name: Kubernetes Debug Info
        run: |
          echo "====== Pods ======"
          kubectl get pods -n backend -o wide

          echo "====== ReplicaSets ======"
          kubectl get rs -n backend

          echo "====== Services ======"
          kubectl get svc -n backend

      # --------------------------------------------------
      # 9Ô∏è‚É£ Detect Minikube Service Port
      # --------------------------------------------------
      - name: Detect Minikube Service Port
        id: minikube-port
        run: |
          SERVICE_URL=$(minikube service backend-service -n backend --url)
          echo "Minikube URL: $SERVICE_URL"

          PORT=$(echo $SERVICE_URL | sed -E 's/.*:([0-9]+)$/\1/')
          echo "Detected Port: $PORT"

          echo "PORT=$PORT" >> $GITHUB_ENV

      # --------------------------------------------------
      # üîü Generate HAProxy config dynamically
      # --------------------------------------------------
      - name: Generate HAProxy Config
        run: |
          sed "s/MINIKUBE_PORT/${PORT}/g" haproxy.cfg > haproxy.ci.cfg
          echo "====== HAProxy Config ======"
          cat haproxy.ci.cfg

      # --------------------------------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Start HAProxy (WORKING FIX)
      # --------------------------------------------------
      - name: Start HAProxy Load Balancer
        run: |
          docker rm -f haproxy-ci || true
          docker run -d \
            --name haproxy-ci \
            -p 9090:9090 \
            -v $PWD/haproxy.ci.cfg:/usr/local/etc/haproxy/haproxy.cfg \
            haproxy:2.9

      # --------------------------------------------------
      # 1Ô∏è‚É£2Ô∏è‚É£ Test HAProxy Endpoint
      # --------------------------------------------------
      - name: Test HAProxy Endpoint
        run: |
          echo "========================================"
          echo "üö¶ HAProxy URL:"
          echo "http://localhost:9090"
          echo "========================================"
          sleep 5
          curl -v http://localhost:9090/healthz
          curl -v http://localhost:9090

      # --------------------------------------------------
      # 1Ô∏è‚É£3Ô∏è‚É£ Cleanup
      # --------------------------------------------------
      - name: Cleanup HAProxy
        if: always()
        run: docker rm -f haproxy-ci || true
