name: CI-CD Pipeline with HAProxy Failover

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  ci-cd:
    runs-on: self-hosted
    timeout-minutes: 20

    steps:
      # -------------------------------
      # Checkout
      # -------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------------
      # Docker login
      # -------------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # -------------------------------
      # Build & push image
      # -------------------------------
      - name: Build Docker image
        run: |
          docker build -t mukul1599/backend-service:latest .

      - name: Push Docker image
        run: |
          docker push mukul1599/backend-service:latest

      # -------------------------------
      # Create KIND cluster
      # -------------------------------
      - name: Create Kubernetes cluster
        run: |
          kind create cluster --name ci-cluster || true
          kubectl cluster-info

      # -------------------------------
      # Deploy application
      # -------------------------------
      - name: Deploy backend service
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      # -------------------------------
      # Wait briefly (non-blocking)
      # -------------------------------
      - name: Short wait for pods
        run: sleep 20

      # -------------------------------
      # Debug Kubernetes
      # -------------------------------
      - name: Kubernetes status
        run: |
          echo "==== Pods ===="
          kubectl get pods -n backend -o wide

          echo "==== Services ===="
          kubectl get svc -n backend

      # -------------------------------
      # Get service URLs
      # -------------------------------
      - name: Get service URLs
        run: |
          HOT_URL=$(minikube service backend-service -n backend --url || true)
          echo "HOT_URL=$HOT_URL" >> $GITHUB_ENV

      # -------------------------------
      # Start HAProxy (PORT 9090)
      # -------------------------------
      - name: Start HAProxy load balancer
        run: |
          echo "Starting HAProxy on port 9090"
          docker run -d \
            --name haproxy-ci \
            -p 9090:9090 \
            -v $PWD/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg \
            haproxy:2.9

      # -------------------------------
      # Validate HAProxy
      # -------------------------------
      - name: Test HAProxy routing
        run: |
          echo "========================================"
          echo "HAProxy running at:"
          echo "http://localhost:9090"
          echo "========================================"

          sleep 5
          curl -v http://localhost:9090/healthz || true
          curl -v http://localhost:9090 || true

      # -------------------------------
      # Final cleanup (optional)
      # -------------------------------
      - name: Cleanup
        if: always()
        run: |
          docker rm -f haproxy-ci || true
