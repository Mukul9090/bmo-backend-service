name: CI-CD with Kubernetes (KIND)

on:
  push:
    branches: [ "main" ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ğŸ” Docker login
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # ğŸ³ Build & push image
    - name: Build and Push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: mukul1599/backend-service:latest

    # â˜¸ï¸ Install kubectl
    - name: Install kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: v1.29.0

    # â˜¸ï¸ Install KIND
    - name: Install KIND
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.23.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind

    # â˜¸ï¸ Create Kubernetes cluster
    - name: Create KIND cluster
      run: |
        kind create cluster --name ci-cluster

    # ğŸš€ Deploy to Kubernetes
    - name: Deploy app to Kubernetes
      run: |
        kubectl create namespace backend || true
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml

    # ğŸ” Verify deployment
    - name: Verify Pods
      run: |
        kubectl get pods -n backend
        kubectl get svc -n backend
