name: CI-CD Pipeline (Self-Hosted Runner + Visible URL)

on:
  push:
    branches:
      - main

jobs:
  ci-cd:
    runs-on:
      - self-hosted
      - macOS
      - ARM64

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Login to Docker Hub (REQUIRED)
      - name: Docker Hub Login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
            -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # 3Ô∏è‚É£ Build Docker image locally
      - name: Build Docker Image
        run: |
          docker build -t mukul1599/backend-service:latest .

      # 4Ô∏è‚É£ Push image to Docker Hub
      - name: Push Docker Image
        run: |
          docker push mukul1599/backend-service:latest

      # 5Ô∏è‚É£ Ensure Minikube is running
      - name: Start Minikube
        run: |
          minikube status || minikube start --driver=docker
          kubectl config use-context minikube

      # 6Ô∏è‚É£ Deploy to Kubernetes (Minikube)
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap-hot.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      # 7Ô∏è‚É£ Wait for deployment (non-fatal)
      - name: Wait for Pods
        run: |
          kubectl rollout status deployment/backend-service \
            -n backend --timeout=300s || true

      # 8Ô∏è‚É£ Print Service URL (üî• IMPORTANT üî•)
      - name: Show Application URL
        run: |
          echo "========================================"
          echo "üöÄ Application URL:"
          minikube service backend-service -n backend --url
          echo "========================================"

      # 9Ô∏è‚É£ Health Check (safe)
      - name: Health Check
        run: |
          URL=$(minikube service backend-service -n backend --url)
          echo "Checking $URL/healthz"
          curl -v "$URL/healthz" || true
