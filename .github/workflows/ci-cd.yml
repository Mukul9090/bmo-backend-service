name: CI-CD Pipeline (Self-Hosted Runner)

on:
  push:
    branches:
      - main

jobs:
  ci-cd:
    runs-on:
      - self-hosted
      - macOS
      - ARM64

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Build Docker image locally
      - name: Build Docker Image
        run: |
          docker build -t mukul1599/backend-service:latest .

      # 3️⃣ Push image to Docker Hub (optional but recommended)
      - name: Push Docker Image
        run: |
          docker push mukul1599/backend-service:latest

      # 4️⃣ Deploy to Minikube
      - name: Deploy to Kubernetes (Minikube)
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap-hot.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      # 5️⃣ Verify deployment
      - name: Verify Pods
        run: |
          kubectl get pods -n backend
          kubectl get svc -n backend
