name: CI-CD Pipeline (Self-Hosted Runner + Minikube + HAProxy)

on:
  push:
    branches:
      - main

jobs:
  ci-cd:
    runs-on:
      - self-hosted
      - macOS
      - ARM64

    timeout-minutes: 20

    steps:
      # --------------------------------------------------
      # 1Ô∏è‚É£ Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # 2Ô∏è‚É£ Docker Hub Login
      # --------------------------------------------------
      - name: Docker Hub Login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
            -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # --------------------------------------------------
      # 3Ô∏è‚É£ Build & Push Image
      # --------------------------------------------------
      - name: Build Docker Image
        run: docker build -t mukul1599/backend-service:latest .

      - name: Push Docker Image
        run: docker push mukul1599/backend-service:latest

      # --------------------------------------------------
      # 4Ô∏è‚É£ Start Minikube
      # --------------------------------------------------
      - name: Start Minikube
        run: |
          minikube status || minikube start --driver=docker
          kubectl config use-context minikube

      # --------------------------------------------------
      # 5Ô∏è‚É£ Cleanup Old Resources (SAFE)
      # --------------------------------------------------
      - name: Cleanup old Kubernetes resources
        run: |
          kubectl delete deployment backend-service -n backend --ignore-not-found
          kubectl delete deployment haproxy -n backend --ignore-not-found
          kubectl delete pod -n backend -l app=backend-service --force --grace-period=0 || true
          kubectl delete pod -n backend -l app=haproxy --force --grace-period=0 || true

      # --------------------------------------------------
      # 6Ô∏è‚É£ Deploy Backend
      # --------------------------------------------------
      - name: Deploy Backend to Kubernetes
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap-hot.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      # --------------------------------------------------
      # 7Ô∏è‚É£ Wait for Backend Ready
      # --------------------------------------------------
      - name: Wait for backend pod readiness
        run: |
          kubectl wait --for=condition=Ready pod \
            -l app=backend-service \
            -n backend \
            --timeout=120s

      # --------------------------------------------------
      # 8Ô∏è‚É£ Debug Backend
      # --------------------------------------------------
      - name: Debug Backend Pod
        run: |
          kubectl get pods -n backend -o wide
          kubectl logs -n backend -l app=backend-service || true

      # --------------------------------------------------
      # 9Ô∏è‚É£ Deploy HAProxy (KUBERNETES, NOT DOCKER)
      # --------------------------------------------------
      - name: Deploy HAProxy to Kubernetes
        run: |
          kubectl apply -f k8s/haproxy-config.yaml
          kubectl apply -f k8s/haproxy-deployment.yaml
          kubectl apply -f k8s/haproxy-service.yaml

      # --------------------------------------------------
      # üîü Wait for HAProxy Ready
      # --------------------------------------------------
      - name: Wait for HAProxy readiness
        run: |
          kubectl wait --for=condition=Ready pod \
            -l app=haproxy \
            -n backend \
            --timeout=120s

      # --------------------------------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Test HAProxy
      # --------------------------------------------------
      - name: Test HAProxy
        run: |
          MINIKUBE_IP=$(minikube ip)
          echo "HAProxy URL: http://$MINIKUBE_IP:30909"
          curl -v http://$MINIKUBE_IP:30909/healthz

      # --------------------------------------------------
      # 1Ô∏è‚É£2Ô∏è‚É£ Final Debug Snapshot
      # --------------------------------------------------
      - name: Final Cluster State
        if: always()
        run: |
          kubectl get all -n backend
