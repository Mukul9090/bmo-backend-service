apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config
  namespace: default
data:
  haproxy.cfg: |
    global
      maxconn 2048
      log stdout format raw local0
      stats socket /var/run/haproxy/admin.sock mode 660 level admin
      stats timeout 2m

    defaults
      mode http
      option httplog
      option log-health-checks
      log-format "%ci:%cp [%t] %ft %b/%s %Tt/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
      timeout connect 2s
      timeout client  30s
      timeout server  30s
      timeout check   1s
      timeout http-request 2s

    # Stats endpoint for debugging
    frontend stats
      bind *:8404
      stats enable
      stats uri /stats
      stats refresh 5s
      stats admin if TRUE

    frontend http_front
      bind *:9090
      default_backend backend_pool

    backend backend_pool
      option httpchk GET /healthz
      http-check expect status 200
      balance roundrobin
      
      # Hot cluster (primary) - will automatically get traffic when healthy
      # Uses DNS name to avoid IP mismatch issues when services are recreated
      # Replace <HOT_CLUSTER_EXTERNAL_IP> with DNS name or IP during deployment
      # Example: backend-service.default.svc.cluster.local:80 or 192.168.1.100:80
      server hot <HOT_CLUSTER_EXTERNAL_IP> check inter 1s fall 2 rise 2 fastinter 500ms downinter 1s
      
      # Standby cluster (backup) - only used when hot is down
      # Uses DNS name to avoid IP mismatch issues when services are recreated
      # Replace <STANDBY_CLUSTER_EXTERNAL_IP> with DNS name or IP during deployment
      # Example: backend-service.default.svc.cluster.local:80 or 192.168.1.101:80
      server standby <STANDBY_CLUSTER_EXTERNAL_IP> check inter 1s fall 2 rise 2 fastinter 500ms downinter 1s backup

