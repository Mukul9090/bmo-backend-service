---
# OpenSCAP Vulnerability Scanning Tasks
- name: Install OpenSCAP tools
  apt:
    name:
      - openscap-scanner
      - ssg-debderiv
      - ssg-debian
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"
  ignore_errors: yes

- name: Check if OpenSCAP content is available
  stat:
    path: "/usr/share/ssg/ssg-debian{{ ansible_distribution_major_version }}-xccdf.xml"
  register: openscap_content
  when: ansible_os_family == "Debian"

- name: Run OpenSCAP vulnerability scan
  command: >
    oscap xccdf eval
    --profile xccdf_org.ssgproject.content_profile_cis
    --results /tmp/openscap-results-{{ inventory_hostname }}-{{ ansible_date_time.epoch }}.xml
    --report /tmp/openscap-report-{{ inventory_hostname }}-{{ ansible_date_time.epoch }}.html
    /usr/share/ssg/ssg-debian{{ ansible_distribution_major_version }}-xccdf.xml
  register: openscap_scan
  changed_when: false
  failed_when: false
  when:
    - ansible_os_family == "Debian"
    - openscap_content.stat.exists
  ignore_errors: yes

- name: Display scan summary
  debug:
    msg:
      - "OpenSCAP vulnerability scan completed"
      - "Results: /tmp/openscap-results-{{ inventory_hostname }}-{{ ansible_date_time.epoch }}.xml"
      - "Report: /tmp/openscap-report-{{ inventory_hostname }}-{{ ansible_date_time.epoch }}.html"
      - "Review the HTML report for detailed vulnerability findings"
  when:
    - openscap_scan is defined
    - openscap_scan.rc is defined
    - openscap_scan.rc == 0

- name: Display scan error message
  debug:
    msg:
      - "⚠️  OpenSCAP scan could not be completed"
      - "This may be due to missing security content or installation issues"
      - "You can manually install: apt-get install openscap-scanner ssg-debderiv ssg-debian"
  when:
    - openscap_scan is defined
    - openscap_scan.rc is defined
    - openscap_scan.rc != 0
