---
# Network Configuration Tasks
- name: Configure kernel modules and sysctl
  block:
    - name: Load kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop: [br_netfilter, overlay]
    - name: Ensure modules load on boot
      lineinfile:
        path: /etc/modules-load.d/k8s.conf
        line: "{{ item }}"
        create: yes
      loop: [br_netfilter, overlay]
    - name: Configure sysctl parameters
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        sysctl_set: yes
        reload: yes
      loop:
        - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { key: 'net.ipv4.ip_forward', value: '1' }
  when: ansible_os_family == "Debian"
